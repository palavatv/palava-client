(function(){var t=[].slice;this.namespace=function(e,r,n){var o,i,s,a,u,h;for(arguments.length<3&&(u=["undefined"!=typeof exports?exports:window].concat(t.call(arguments)),e=u[0],r=u[1],n=u[2]),i=e,h=r.split("."),s=0,a=h.length;a>s;s++)o=h[s],e=e[o]||(e[o]={});return n(e,i)}}).call(this),function(){namespace("palava.browser",function(t){return t.PeerConnection=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,t.IceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,t.SessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,t.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,t.isMozilla=function(){return window.mozRTCPeerConnection?!0:!1},t.isChrome=function(){return/Chrome/i.test(navigator.userAgent)},t.getUserAgent=function(){return t.isMozilla()?"firefox":t.isChrome()?"chrome":"unknown"},t.checkForWebrtcError=function(){var e;try{new t.PeerConnection({iceServers:[]})}catch(r){return e=r}return!(t.PeerConnection&&t.IceCandidate&&t.SessionDescription&&t.getUserMedia)},t.checkForPartialSupport=function(){var t,e,r;return t=/Chrome\/(\d+)/i.exec(navigator.userAgent),t?(r=t[0],e=t[1],parseInt(e)<26):!1},t.getConstraints=function(){var e;return e={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},t.isMozilla()&&(e.mandatory.MozDontOfferDataChannel=!0),e},t.getPeerConnectionOptions=function(){return t.isChrome()?{optional:[{DtlsSrtpKeyAgreement:!0}]}:{}},t.patchSDP=function(t){var e,r,n,o,i,s,a,u,h;for(e=function(){for(h=[],s=33;58>=s;s++)h.push(s);return h}.apply(this).concat(function(){for(u=[],i=60;126>=i;i++)u.push(i);return u}.apply(this)).map(function(t){return String.fromCharCode(t)}),o="",n=a=0;40>a;n=++a)o+=e[Math.floor(Math.random()*e.length)];return r="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:"+o+"\r\nc=IN",-1===t.sdp.indexOf("a=crypto")&&(t.sdp=t.sdp.replace(/c=IN/g,r)),t},t.registerFullscreen=function(t,e){return t[0].requestFullscreen?t.on(e,function(){return this.requestFullscreen()}):t[0].mozRequestFullScreen?t.on(e,function(){return this.mozRequestFullScreen()}):t[0].webkitRequestFullscreen?t.on(e,function(){return this.webkitRequestFullscreen()}):void 0},t.isMozilla()?(t.attachMediaStream=function(t,e){return e?$(t).prop("mozSrcObject",e):$(t).prop("mozSrcObject",null)},t.fixAudio=function(){}):t.isChrome()?(t.attachMediaStream=function(t,e){return e?$(t).prop("src",webkitURL.createObjectURL(e)):$(t).prop("src",null)},t.fixAudio=function(t){return"true"!==t.attr("data-peer-muted")?$([200,400,1e3,2e3,4e3,8e3,16e3]).each(function(e,r){return setTimeout(function(){return t.find(".plv-video-mute").click(),t.find(".plv-video-mute").click()},r)}):void 0}):void 0})}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var o in e)r.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(t){function r(t){this.releaseStream=e(this.releaseStream,this),this.getStream=e(this.getStream,this),this.requestStream=e(this.requestStream,this),this.config=t||{video:!0,audio:!0},this.stream=null}return n(r,t),r.prototype.requestStream=function(){var t=this;return palava.browser.getUserMedia.call(navigator,this.config,function(e){return t.stream=e,t.emit("stream_ready",t)},function(){return t.emit("stream_error",t)}),!0},r.prototype.getStream=function(){return this.stream},r.prototype.releaseStream=function(){return this.stream?(this.stream.stop(),this.stream=null,this.emit("stream_released",this),!0):!1},r}(EventEmitter),namespace("palava",function(e){return e.Gum=t})}.call(this),function(){var t;t=function(){function t(t){this.userMediaConfig=t.userMediaConfig,this.name=t.name}return t.prototype.newUserMedia=function(){return new palava.Gum(this.userMediaConfig)},t.prototype.getName=function(){return this.name},t}(),namespace("palava",function(e){return e.Identity=t})}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var o in e)r.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(t){function r(t,r){this.isLocal=e(this.isLocal,this),this.isReady=e(this.isReady,this),this.isMuted=e(this.isMuted,this),this.hasAudio=e(this.hasAudio,this);var n;this.id=t,this.status=r||{},(n=this.status).user_agent||(n.user_agent=palava.browser.getUserAgent()),this.joinTime=(new Date).getTime()}return n(r,t),r.prototype.hasAudio=function(){return palava.browser.checkForPartialSupport()||this.getStream()&&this.getStream().getAudioTracks().length},r.prototype.isMuted=function(){return this.muted?!0:!1},r.prototype.isReady=function(){return this.ready?!0:!1},r.prototype.isLocal=function(){return this.local?!0:!1},r}(EventEmitter),namespace("palava",function(e){return e.Peer=t})}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var o in e)r.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(t){function r(t,n,o){this.leave=e(this.leave,this),this.toggleMute=e(this.toggleMute,this),this.hasAudio=e(this.hasAudio,this),this.updateStatus=e(this.updateStatus,this),this.getStream=e(this.getStream,this),this.setupRoom=e(this.setupRoom,this),this.setupUserMedia=e(this.setupUserMedia,this),this.muted=!0,this.local=!0,r.__super__.constructor.call(this,t,n),this.room=o,this.userMedia=o.userMedia,this.setupRoom(),this.setupUserMedia()}return n(r,t),r.prototype.setupUserMedia=function(){var t=this;return this.userMedia.on("stream_released",function(){return t.ready=!1,t.emit("stream_removed")}),this.userMedia.on("stream_ready",function(e){return t.ready=!0,t.emit("stream_ready",e)}),this.getStream()?(this.ready=!0,this.emit("stream_ready")):void 0},r.prototype.setupRoom=function(){var t=this;return this.room.peers[this.id]=this.room.localPeer=this,this.on("update",function(){return t.room.emit("peer_update",t)}),this.on("stream_ready",function(){return t.room.emit("peer_stream_ready",t)}),this.on("stream_removed",function(){return t.room.emit("peer_stream_removed",t)})},r.prototype.getStream=function(){return this.userMedia.getStream()},r.prototype.updateStatus=function(t){var e,r;if(!(t&&t instanceof Object&&0!==Object.keys(t).length))return t;for(e in t)this.status[e]=t[e];return(r=this.status).user_agent||(r.user_agent=palava.browser.getUserAgent()),this.room.channel.send({event:"update_status",status:this.status}),this.status},r.prototype.hasAudio=function(){return!1},r.prototype.toggleMute=function(){return!1},r.prototype.leave=function(){return this.ready=!1,this.emit("left")},r}(palava.Peer),namespace("palava",function(e){return e.LocalPeer=t})}.call(this),function(){var t;t=function(t,e){return null==e&&(e=null),{on:function(r,n){return t.on("message",function(t){if(e){if(t.sender_id===e&&r===t.event)return n(t)}else if(!t.sender_id&&r===t.event)return n(t)})},send:function(r){var n;return n=e?{event:"send_to_peer",peer_id:e,data:r}:r,t.send(n)}}},namespace("palava",function(e){return e.Distributor=t})}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var o in e)r.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(t){function r(t,n,o){this.mozillaCheckAddStream=e(this.mozillaCheckAddStream,this),this.oaError=e(this.oaError,this),this.sdpSender=e(this.sdpSender,this),this.sendAnswer=e(this.sendAnswer,this),this.sendOfferIf=e(this.sendOfferIf,this),this.sendOffer=e(this.sendOffer,this),this.setupRoom=e(this.setupRoom,this),this.setupDistributor=e(this.setupDistributor,this),this.setupPeerConnection=e(this.setupPeerConnection,this),this.toggleMute=e(this.toggleMute,this),this.hasAudio=e(this.hasAudio,this),this.getStream=e(this.getStream,this),this.muted=!1,this.local=!1,r.__super__.constructor.call(this,t,n),this.room=o,this.remoteStream=null,this.setupRoom(),this.setupPeerConnection(),this.setupDistributor()}return n(r,t),r.prototype.getStream=function(){return this.remoteStream},r.prototype.hasAudio=function(){return this.remoteStream&&(palava.browser.checkForPartialSupport()||this.remoteStream.getAudioTracks().length)},r.prototype.toggleMute=function(){return this.muted=!this.muted},r.prototype.setupPeerConnection=function(){var t=this;return this.peerConnection=new palava.browser.PeerConnection({iceServers:[{url:this.room.options.stun}]},palava.browser.getPeerConnectionOptions()),this.peerConnection.onicecandidate=function(e){return e.candidate?t.distributor.send({event:"ice_candidate",sdpmlineindex:e.candidate.sdpMLineIndex,sdpmid:e.candidate.sdpMid,candidate:e.candidate.candidate}):void 0},this.peerConnection.onaddstream=function(e){return t.remoteStream=e.stream,t.ready=!0,t.emit("stream_ready")},this.peerConnection.onremovestream=function(){return t.remoteStream=null,t.ready=!1,t.emit("stream_removed")},this.room.localPeer.getStream()&&this.peerConnection.addStream(this.room.localPeer.getStream()),this.peerConnection},r.prototype.setupDistributor=function(){var t=this;return this.distributor=palava.Distributor(this.room.channel,this.id),this.distributor.on("peer_left",function(){return t.ready&&(t.remoteStream=null,t.emit("stream_removed"),t.ready=!1),t.peerConnection.close(),t.emit("left")}),this.distributor.on("ice_candidate",function(e){var r;return r=new palava.browser.IceCandidate({candidate:e.candidate,sdpMLineIndex:e.sdpmlineindex,sdpMid:e.sdpmid}),t.peerConnection.addIceCandidate(r)}),this.distributor.on("offer",function(e){return t.peerConnection.setRemoteDescription(new palava.browser.SessionDescription(e.sdp)),t.emit("offer"),t.sendAnswer()}),this.distributor.on("answer",function(e){return t.peerConnection.setRemoteDescription(new palava.browser.SessionDescription(e.sdp)),t.emit("answer")}),this.distributor.on("peer_updated_status",function(e){return t.status=e.status,t.emit("update")}),this.distributor},r.prototype.setupRoom=function(){var t=this;return this.room.peers[this.id]=this,this.on("left",function(){return delete t.room.peers[t.id],t.room.emit("peer_left",t)}),this.on("offer",function(){return t.room.emit("peer_offer",t)}),this.on("answer",function(){return t.room.emit("peer_answer",t)}),this.on("update",function(){return t.room.emit("peer_update",t)}),this.on("stream_ready",function(){return t.room.emit("peer_stream_ready",t)}),this.on("stream_removed",function(){return t.room.emit("peer_stream_removed",t)}),this.on("oaerror",function(e){return t.room.emit("peer_oaerror",t,e)})},r.prototype.sendOffer=function(){return this.peerConnection.createOffer(this.sdpSender("offer"),this.oaError,palava.browser.getConstraints()),this.mozillaCheckAddStream()},r.prototype.sendOfferIf=function(t){return t?this.sendOffer():void 0},r.prototype.sendAnswer=function(){return this.peerConnection.createAnswer(this.sdpSender("answer"),this.oaError,palava.browser.getConstraints()),this.mozillaCheckAddStream()},r.prototype.sdpSender=function(t){var e=this;return function(r){return r=palava.browser.patchSDP(r),e.peerConnection.setLocalDescription(r),e.distributor.send({event:t,sdp:r})}},r.prototype.oaError=function(t){return this.emit("oaerror",t)},r.prototype.mozillaCheckAddStream=function(){var t,e=this;return palava.browser.isMozilla()?t=$([100,200,400,1e3,2e3,4e3,8e3,12e3,16e3]).map(function(r,n){return setTimeout(function(){var r;return(r=e.peerConnection.remoteStreams&&e.peerConnection.remoteStreams[0]||e.peerConnection.getRemoteStreams()&&e.peerConnection.getRemoteStreams()[0])?(t.each(function(t,e){return clearTimeout(e)}),e.peerConnection.onaddstream({stream:r})):void 0},n)}):void 0},r}(palava.Peer),namespace("palava",function(e){return e.RemotePeer=t})}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var o in e)r.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(t){function r(t,r,n,o){null==o&&(o={}),this.getAllPeers=e(this.getAllPeers,this),this.getRemotePeers=e(this.getRemotePeers,this),this.getLocalPeer=e(this.getLocalPeer,this),this.getPeerById=e(this.getPeerById,this),this.leave=e(this.leave,this),this.join=e(this.join,this),this.setupDistributor=e(this.setupDistributor,this),this.setupOptions=e(this.setupOptions,this),this.setupChannel=e(this.setupChannel,this),this.setupUserMedia=e(this.setupUserMedia,this),this.id=t,this.userMedia=n,this.channel=r,this.peers={},this.options=o,this.setupUserMedia(),this.setupChannel(),this.setupDistributor(),this.setupOptions()}return n(r,t),r.prototype.setupUserMedia=function(){var t=this;return this.userMedia.on("stream_ready",function(e){return t.emit("local_stream_ready",e.stream)}),this.userMedia.on("stream_released",function(){return t.emit("local_stream_removed")})},r.prototype.setupChannel=function(){var t=this;return this.channel.on("not_reachable",function(e){return t.emit("signaling_not_reachable",e)}),this.channel.on("error",function(e){return t.emit("signaling_error",e)}),this.channel.on("close",function(e){return t.emit("signaling_close",e)})},r.prototype.setupOptions=function(){var t,e;return(t=this.options).joinTimeout||(t.joinTimeout=1e3),(e=this.options).ownStatus||(e.ownStatus={})},r.prototype.setupDistributor=function(){var t=this;return this.distributor=palava.Distributor(this.channel),this.distributor.on("joined_room",function(e){var r,n,o,i,s;for(clearTimeout(t.joinCheckTimeout),new palava.LocalPeer(e.own_id,t.options.ownStatus,t),s=e.peers,o=0,i=s.length;i>o;o++)n=s[o],r=new palava.RemotePeer(n.peer_id,n.status,t),r.sendOfferIf(!palava.browser.isChrome());return t.emit("joined",t)}),this.distributor.on("new_peer",function(e){var r;return r=new palava.RemotePeer(e.peer_id,e.status,t),r.sendOfferIf("chrome"===e.status.user_agent),t.emit("peer_joined",r)}),this.distributor.on("error",function(e){return t.emit("signaling_error",e.message)}),this.distributor.on("shutdown",function(e){return t.emit("signaling_shutdown",e.seconds)})},r.prototype.join=function(t){var e,r,n,o,i=this;for(null==t&&(t={}),this.joinCheckTimeout=setTimeout(function(){return i.emit("join_error","Not able to join room"),i.leave()},this.options.joinTimeout),n=0,o=t.length;o>n;n++)e=t[n],this.options.ownStatus[e]=t[e];return(r=this.options.ownStatus).user_agent||(r.user_agent=palava.browser.getUserAgent()),this.distributor.send({event:"join_room",room_id:this.id,status:this.options.ownStatus})},r.prototype.leave=function(){return this.emit("leave"),this.channel&&this.channel.close(),this.localPeer&&this.localPeer.stream&&this.localPeer.stream.close()},r.prototype.getPeerById=function(t){return this.peers[t]},r.prototype.getLocalPeer=function(){return this.localPeer},r.prototype.getRemotePeers=function(){return this.getAllPeers(!1)},r.prototype.getAllPeers=function(t){var e,r,n,o;null==t&&(t=!0),n=[],o=this.peers;for(e in o)r=o[e],(t||!r.local)&&n.push(r);return n},r}(EventEmitter),namespace("palava",function(e){return e.Room=t})}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var o in e)r.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(t){function r(t){this.checkConnectionTimeout=e(this.checkConnectionTimeout,this),this.close=e(this.close,this),this.send=e(this.send,this),this.setupEvents=e(this.setupEvents,this);var r=this;this.reached=!1,this.socket=new WebSocket(t),this.socket.onopen=function(t){return r.setupEvents(),r.emit("open",t)}}return n(r,t),r.prototype.setupEvents=function(){var t=this;return this.socket.onmessage=function(e){var r;try{return t.emit("message",JSON.parse(e.data))}catch(n){return r=n,t.emit("error_invalid_json",e)}},this.socket.onerror=function(e){return t.emit("error",e)},this.socket.onclose=function(){return t.emit("close")}},r.prototype.send=function(t){return this.socket.send(JSON.stringify(t)),this.reached?void 0:this.checkConnectionTimeout()},r.prototype.close=function(){return this.socket.close()},r.prototype.checkConnectionTimeout=function(){var t=this;return setTimeout(function(){return 3===t.socket.readyState?t.emit("not_reachable",t.serverAddress):t.reached=!0},500)},r}(EventEmitter),namespace("palava",function(e){return e.WebSocketChannel=t})}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var o in e)r.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(t){function r(t){this.destroy=e(this.destroy,this),this.setupRoom=e(this.setupRoom,this),this.getRoom=e(this.getRoom,this),this.getUserMedia=e(this.getUserMedia,this),this.getChannel=e(this.getChannel,this),this.checkRequirements=e(this.checkRequirements,this),this.assignOptions=e(this.assignOptions,this),this.init=e(this.init,this),this.channel=null,this.userMedia=null,this.roomId=null,this.roomOptions={},this.assignOptions(t)}return n(r,t),r.prototype.init=function(t){return this.assignOptions(t),this.checkRequirements(),this.setupRoom(),this.userMedia.requestStream()},r.prototype.assignOptions=function(t){return this.roomId=t.roomId||this.roomId,t.channel?this.channel=t.channel:t.web_socket_channel&&(this.channel=new palava.WebSocketChannel(t.web_socket_channel)),t.identity&&(this.userMedia=t.identity.newUserMedia(),this.roomOptions.ownStatus={name:t.identity.getName()}),t.options?(this.roomOptions.stun=t.options.stun||this.roomOptions.stun,this.roomOptions.joinTimeout=t.options.joinTimeout||this.roomOptions.joinTimeout):void 0},r.prototype.checkRequirements=function(){var t;return this.channel?this.userMedia?this.roomId?this.roomOptions.stun?(t=palava.browser.checkForWebrtcError())?(this.emit("webrtc_no_support","WebRTC is not supported by your browser",t),void 0):palava.browser.checkForPartialSupport()?this.emit("webrtc_partial_support"):void 0:(this.emit("argument_error","no stun server given"),void 0):(this.emit("argument_error","no room id given"),void 0):(this.emit("argument_error","no user media given"),void 0):(this.emit("argument_error","no channel given"),void 0)},r.prototype.getChannel=function(){return this.channel},r.prototype.getUserMedia=function(){return this.userMedia},r.prototype.getRoom=function(){return this.room},r.prototype.setupRoom=function(){var t=this;return this.room=new palava.Room(this.roomId,this.channel,this.userMedia,this.roomOptions),this.room.on("local_stream_ready",function(e){return t.emit("local_stream_ready",e)}),this.room.on("local_stream_error",function(){return t.emit("local_stream_error")}),this.room.on("local_stream_removed",function(){return t.emit("local_stream_removed")}),this.room.on("join_error",function(e){return t.emit("room_join_error",t.room,e)}),this.room.on("full",function(){return t.emit("room_full",t.room)}),this.room.on("joined",function(){return t.emit("room_joined",t.room)}),this.room.on("peer_joined",function(e){return t.emit("peer_joined",e)}),this.room.on("peer_offer",function(e){return t.emit("peer_offer",e)}),this.room.on("peer_answer",function(e){return t.emit("peer_answer",e)}),this.room.on("peer_update",function(e){return t.emit("peer_update",e)}),this.room.on("peer_stream_ready",function(e){return t.emit("peer_stream_ready",e)}),this.room.on("peer_stream_removed",function(e){return t.emit("peer_stream_removed",e)}),this.room.on("peer_left",function(e){return t.emit("peer_left",e)}),this.room.on("signaling_shutdown",function(e){return t.emit("signaling_shutdown",e)}),this.room.on("signaling_close",function(e){return t.emit("signaling_close",e)}),this.room.on("signaling_error",function(e){return t.emit("signaling_error",e)}),this.room.on("signaling_not_reachable",function(e){return t.emit("signaling_not_reachable",e)}),!0},r.prototype.destroy=function(){return this.emit("session_before_destroy"),this.room&&this.room.leave(),this.channel&&this.channel.close(),this.userMedia&&this.userMedia.releaseStream(),this.emit("session_after_destroy")},r}(EventEmitter),namespace("palava",function(e){return e.Session=t})}.call(this),function(){namespace("palava",function(t){return t.PROTOCOL_NAME="palava",t.PROTOCOL_VERSION="1.0.0",t.protocol_identifier=function(){return t.PROTOCOL_NAME="palava.1.0"}})}.call(this);